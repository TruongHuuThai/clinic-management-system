<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>
        <%= title %> - Quản Lý Phòng Khám
    </title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js'></script> 
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
    <header>
    </header>

    

    <main class="container">
        <h1>
            <%= title %>
        </h1>

        <div class="">
            <button onclick="window.location.href='/'" class="btn btn-primary">
                Trang chủ
            </button>
            <button onclick="danhSachBenhNhan()" class="btn btn-primary">
                Danh sách bệnh nhân
            </button>
        </div>

    <div class="mt-4 mb-3">
        <button id="listViewBtn" class="btn btn-info">Danh sách</button>
        <button id="calendarViewBtn" class="btn btn-outline-info">Lịch</button>
    </div>

    <div id='calendar-container' style="display: none;">
        <div id='fullCalendar'></div>
    </div>

    <div id="filter-container" class="mb-4 p-3 border rounded">
        <form id="filterForm" onsubmit="event.preventDefault(); applyFilters()">
            
            <label for="search">Tìm kiếm (Tên/SĐT):</label>
            <input type="text" id="search" name="search" value="<%= query.search || '' %>"> 

            <label for="status">Trạng thái:</label>
            <select id="status" name="status">
                <option value="">Tất cả</option>
                <option value="CHO_KHAM" <%= query.status === 'CHO_KHAM' ? 'selected' : '' %>>Chờ Khám</option>
                <option value="DA_DEN" <%= query.status === 'DA_DEN' ? 'selected' : '' %>>Đã Đến</option>
            </select>
            
            <label for="dateFrom">Từ ngày:</label>
            <input type="date" id="dateFrom" name="dateFrom" value="<%= query.dateFrom || '' %>">

            <button type="submit" class="btn btn-primary">Áp dụng</button>
            <button type="button" onclick="danhSachLichHen()" class="btn btn-secondary">Xóa lọc</button>
        </form>
    </div>

    <div id='list-container'>
        </div>
    
        <p>Tổng số lịch hẹn: **<%= data.totalCount %>**</p>

        <div>
            <button onclick="themLichHen()">Thêm lịch hẹn</button>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Thời gian</th>
                    <th>Ngày hẹn</th>
                    <th>Bệnh nhân</th>
                    <th>Trạng thái</th>
                    <th>Ghi chú</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <% data.appointments.forEach((item, index)=> { %>
                    <tr>
                        <td>
                            <%= index + 1 %>
                        </td>
                        <td>
                            <%= item.time %>
                        </td>
                        <td>
                            <%= item.date.toLocaleDateString('vi-VN') %>
                        </td>
                        <td>
                                <%= item.name %>
                        </td>
                        <td>
                            <span class="status-badge status ">
                               <%
                            let displayStatus = '';

                            // 1. Lấy và chuẩn hóa giá trị gốc
                            const normalizedStatus = item.status ? item.status.trim().toUpperCase() : '';

                            // 2. So sánh với giá trị đã chuẩn hóa
                            if (normalizedStatus === 'DA DEN') {
                                displayStatus = 'Đã đến';
                            } else if (normalizedStatus === 'CHO KHAM') {
                                displayStatus = 'Chờ khám';
                            } else if (normalizedStatus === 'DA HUY') {
                                displayStatus = 'Đã hủy';
                            } else if (normalizedStatus === 'CHUA DEN') { 
                                displayStatus = 'Chưa đến';
                            } else {
                                displayStatus = item.status;
                            }
                        %>
                        <%= displayStatus %>
                            </span>
                        </td>
                        <td>
                            <%= item.note %>
                        </td>
                        <td>
                            <button class="btn-sm btn-info" data-id="<%= item.lh_ma %>" onclick="suaLichHen(this)">
                                Sửa
                            </button>
                            <button class="btn-sm btn-danger" data-id="<%= item.lh_ma %>" onclick="xoaLichHen(this)">
                                Xóa
                            </button>
                        </td>
                    </tr>
                    <% }); %>
            </tbody>
        </table>
    </main>

    <script src="/js/appointments.js"></script>
</body>

</html>