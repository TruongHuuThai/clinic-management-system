<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>
        <%= title %> - Quản Lý Phòng Khám
    </title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-datepicker/1.13.0/i18n/jquery.ui.datepicker-vi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js'></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

</head>

<body>
    <header>
    </header>

    <main class="container">

        <%- include('partials/delete_form') %>


        <h1>
            <%= title %>
        </h1>

        <div class="">
            <button onclick="window.location.href='/'" class="btn btn-primary">
                Trang chủ
            </button>
            <button onclick="danhSachBenhNhan()" class="btn btn-primary">
                Danh sách bệnh nhân
            </button>
            
            <button onclick="danhSachLichHen()" class="btn btn-primary">
                Danh sách lịch hẹn
            </button>

        </div>


    <div id='calendar-container' style="display: none;">
        <div id='fullCalendar'></div>
    </div>

    <div id="filter-container" class="mb-4 p-3 border rounded">
        <form id="filterForm" onsubmit="event.preventDefault(); applyFilters()">
            
            <div class="form-group d-inline-block mr-3">
                <label for="search">Tìm kiếm (Tên/SĐT):</label>
                <input type="text" id="search" name="search" value="<%= query.search || '' %>" class="form-control"> 
            </div>

            <div class="form-group d-inline-block mr-3">
                <label for="status">Trạng thái:</label>
                <select id="status" name="status" class="form-control">
                    <option value="">Tất cả</option>
                    <option value="CHO_KHAM" <%= query.status === 'CHO_KHAM' ? 'selected' : '' %>>Chờ Khám</option>
                    <option value="DA_DEN" <%= query.status === 'DA_DEN' ? 'selected' : '' %>>Đã Đến</option>
                    <option value="TAI_KHAM" <%= query.status === 'TAI_KHAM' ? 'selected' : '' %>>Tái Khám</option>
                    <option value="DA_HUY" <%= query.status === 'DA_HUY' ? 'selected' : '' %>>Đã Hủy</option>
                    </select>
            </div>

            <div class="form-group d-inline-block mr-3">
                <label for="dateFrom">Từ ngày:</label>
                <input type="text" id="dateFrom" name="dateFrom" value="<%= query.dateFrom || '' %>" class="datepicker-input form-control" placeholder="dd/mm/yyyy">
            </div>

            <button type="submit" class="btn btn-primary">Áp dụng</button>
            <button type="button" onclick="danhSachLichHen()" class="btn btn-secondary">Xóa lọc</button>
        </form>
    </div>

    <div id='list-container'>
        </div>
    
        <p>Tổng số lịch hẹn: **<%= data.totalCount %>**</p>

        <div>
            <button onclick="themLichHen()">Thêm lịch hẹn</button>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Thời gian</th>
                    <th>Ngày hẹn</th>
                    <th>Bệnh nhân</th>
                    <th>Trạng thái</th>
                    <th>Ghi chú</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                <% data.appointments.forEach((item, index)=> { %>
                    <tr>
                        <td>
                            <%= index + 1 %>
                        </td>
                        <td>
                            <%= item.time %>
                        </td>
                        <td>
                            <%= item.date.toLocaleDateString('vi-VN') %>
                        </td>
                        <td>
                                <%= item.name %>
                        </td>
                        <td>
                            <span class="status-badge status ">
                            <%
                                let displayStatus = '';
                                const normalizedStatus = item.status ? item.status.trim().toUpperCase() : '';

                                // 2. So sánh với giá trị đã chuẩn hóa
                                if (normalizedStatus === 'DA DEN') {
                                    displayStatus = 'Đã đến';
                                } else if (normalizedStatus === 'CHO KHAM') {
                                    displayStatus = 'Chờ khám';
                                } else if (normalizedStatus === 'DA HUY') {
                                    displayStatus = 'Đã hủy';
                                } else if (normalizedStatus === 'CHUA DEN') { 
                                    displayStatus = 'Chưa đến';
                                } else if (normalizedStatus === 'TAI KHAM') {
                                    displayStatus = 'Tái khám';
                                } else {
                                    displayStatus = item.status;
                                }
                            %>
                            <%= displayStatus %>
                            </span>
                        </td>
                        <td>
                            <%= item.note %>
                        </td>
                        <td>
                            <button class="btn-sm btn-info" data-id="<%= item.lh_ma %>" onclick="suaLichHen(this)">
                                Sửa
                            </button>
                            <button class="btn-sm btn-danger" data-id="<%= item.lh_ma %>" onclick="xoaLichHen(this)">
                                Xóa
                            </button>
                        </td>
                    </tr>
                    <% }); %>
            </tbody>
        </table>
    </main>

    <script src="/js/appointments.js"></script>
</body>

</html>