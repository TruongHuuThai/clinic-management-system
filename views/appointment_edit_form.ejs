<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>
        <%= title %> - Quản Lý Lịch Hẹn
    </title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-datepicker/1.13.0/i18n/jquery.ui.datepicker-vi.min.js"></script>

    <script> 


    </script>
</head>

<body>
    <script>
        function getCurrentDateISO() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = new Date(now.getTime() - offset).toISOString().substring(0, 10);
            return localISOTime;
        }
        const minDate = getCurrentDateISO();
    </script>
    <main>
        <div class="form-container">
            <h1>
                <%= title %>
            </h1>

            <div class="">
                <button onclick="window.location.href='/'" class="btn btn-primary">
                    Trang chủ
                </button>

                <button onclick="danhSachBenhNhan()" class="btn btn-primary">
                    Danh sách bệnh nhân
                </button>

                <button onclick="danhSachLichHen()" class="btn btn-primary">
                    Danh sách lịch hẹn
                </button>
            </div>

            <div class="form-group">
                <label for="bn_ho_ten">Tên Bệnh Nhân:</label>
                <input type="text" class="form-control" id="bn_ho_ten" value="<%= appointmentData.bn_ho_ten %>"
                    readonly>
            </div>
            <hr>

            <form id="editAppointmentForm">
                <input type="hidden" id="lh_ma" name="lh_ma" value="<%= appointmentData.lh_ma %>">

                <div class="form-group">
                    <label for="ngay_hen">Ngày Hẹn:</label>

                    <input type="text" class="form-control datepicker-input" id="ngay_hen" name="ngay_hen"
                        <% 
                            let isoDate = appointmentData.lh_ngay_hen ? new Date(appointmentData.lh_ngay_hen).toISOString().substring(0, 10) : ''; 
                        %>
                        value="<%= isoDate %>" placeholder="dd/mm/yyyy" required>
                </div>

                <div class="form-group">
                    <label for="khung_gio">Khung Giờ:</label>
                    <select class="form-control" id="khung_gio" name="khung_gio" required>
                    </select>
                </div>

                <div class="form-group">
                    <label for="trang_thai">Trạng Thái:</label>
                    <select class="form-control" id="trang_thai" name="trang_thai" required>
                        <option value="CHO_KHAM" <%=appointmentData.lh_trang_thai==='CHO_KHAM' ? 'selected' : '' %>>
                            Chờ Khám
                        </option>
                        <option value="DA_DEN" <%=appointmentData.lh_trang_thai==='DA_DEN' ? 'selected' : '' %>>
                            Đã Đến
                        </option>
                        <option value="DA_HUY" <%=appointmentData.lh_trang_thai==='DA_HUY' ? 'selected' : '' %>>
                            Đã Hủy
                        </option>
                        <option value="DA_HUY" <%=appointmentData.lh_trang_thai==='TAI_KHAM' ? 'selected' : '' %>>
                            Tái khám
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="ghi_chu">Ghi Chú:</label>
                    <textarea class="form-control" id="ghi_chu" name="ghi_chu"
                        rows="3"><%= appointmentData.lh_ghi_chu || '' %></textarea>
                </div>

                <div class="form-actions" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                    <button type="button" class="btn btn-primary" onclick="danhSachLichHen()">Hủy</button>
                </div>
                
            </form>
        </div>
    </main>

    <script src="/js/appointment_edit_form.js"></script>

    <script>

        const rawTime = "<%= appointmentData.lh_khung_gio %>";
        const slotValue = (rawTime && rawTime.length >= 5) ? rawTime.substring(0, 5) : '07:00';
        const idValue = "<%= appointmentData.lh_ma %>";
        const occupiedJSON = '<%- JSON.stringify(occupiedSlots) %>';
        const initialOccupiedSlots = JSON.parse(occupiedJSON);

        document.addEventListener('DOMContentLoaded', function () {
            if (typeof initializeFormLogic === 'function') {
                initializeFormLogic(idValue, slotValue, initialOccupiedSlots);
            }
        });

        document.addEventListener('DOMContentLoaded', function () {

            const form = document.getElementById('editAppointmentForm');

            const occupiedSlotsString = form.getAttribute('data-occupied-slots');
            const initialOccupiedSlots = JSON.parse(occupiedSlotsString || '[]');

            function getMinDate() {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const localTime = new Date(now.getTime() - offset);
                return localTime.toISOString().substring(0, 10);
            }
            const dateInput = document.getElementById('ngay_hen');
            if (dateInput) {
                dateInput.setAttribute('min', getMinDate());
            }

            if (typeof initializeFormLogic === 'function') {
                initializeFormLogic(idValue, slotValue, initialOccupiedSlots);
            }
        });

        function getMinDateISO() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localTime = new Date(now.getTime() - offset);
            return localTime.toISOString().substring(0, 10);
        }

$(document).ready(function() {
    
    $(".datepicker-input").datepicker({
        dateFormat: 'dd/mm/yy',
        changeMonth: true,
        changeYear: true,
        yearRange: "1940:2030",
        closeText: 'Đóng',
        currentText: 'Hôm nay',
        // Thiết lập minDate để không chọn ngày trong quá khứ
        minDate: new Date() 
    });

    // CHUYỂN ĐỔI NGÀY SANG ĐỊNH DẠNG HIỂN THỊ (ISO -> VN)
    $(".datepicker-input").each(function() {
        let $input = $(this);
        let isoValue = $input.val();
        
        if (isoValue && isoValue.includes('-')) {
            let parts = isoValue.split('-');
            let displayValue = parts[2] + '/' + parts[1] + '/' + parts[0];
            $input.val(displayValue);
        }
    });


    // XỬ LÝ SỰ KIỆN SUBMIT FORM (KHẮC PHỤC LỖI 500)
    $('#editAppointmentForm').submit(function(e) {
        
        let conversionError = false;

        $(".datepicker-input").each(function() {
            let $input = $(this);
            let dateString = $input.val();
            
            if (dateString && dateString.includes('/')) {
                let parts = dateString.split('/');
                
                // Kiểm tra sơ bộ tính hợp lệ
                if (parts.length === 3 && parts[2].length === 4) {
                    let isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    $input.val(isoDate);
                } else {
                    conversionError = true;
                }
            }
        });

        if (conversionError) {
            e.preventDefault();
            alert("Lỗi định dạng ngày tháng. Vui lòng nhập DD/MM/YYYY.");
            // Tải lại trang để Datepicker khôi phục định dạng cũ
            setTimeout(() => { window.location.reload(); }, 50); 
            return false;
        }
    });
});
    </script>

</body>

</html>