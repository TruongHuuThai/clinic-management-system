<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title><%= title %> - Quản Lý Phòng Khám </title>
    <%- include('partials/thuvien_js') %>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js'></script>

    <link rel="stylesheet" href="/css/partials/placehoder_nghien.css">

</head>
<body>
    <%- include('partials/header') %>
    <% 
        const LIMIT = 10; 
        const viTriOffset = (data.currentPage - 1) * LIMIT; 
    %>
    <main class="container my-4">
        <h1><%= title %></h1>

        <div id="filter-container" class="mb-4 p-3 border rounded bg-light">
            <form id="filterForm" onsubmit="event.preventDefault(); apDungBoLoc()">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <label for="search" class="form-label fw-bold">Tìm Kiếm (Tên/SĐT):</label>
                        <input type="text" id="search" name="search" value="<%= query.tim_kiem || '' %>" class="form-control" placeholder="Nhập tên hoặc SĐT..." autocomplete="off">
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label fw-bold">Trạng thái:</label>
                        <select id="status" name="status" class="form-select">
                            <option value=""> Chọn trạng thái </option>
                            <option value="CHO_KHAM" <%= query.trang_thai === 'CHO_KHAM' ? 'selected' : '' %>>Chờ Khám</option>
                            <option value="DA_DEN" <%= query.trang_thai === 'DA_DEN' ? 'selected' : '' %>>Đã Đến</option>
                            <option value="DA_HUY" <%= query.trang_thai === 'DA_HUY' ? 'selected' : '' %>>Đã Hủy</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="dateFrom" class="form-label fw-bold">Từ ngày:</label>
                        <% 
                            let hienThiNgay = '';
                            if (query.tu_ngay) {
                                const parts = query.tu_ngay.split('-');
                                if (parts.length === 3) {
                                    hienThiNgay = `${parts[2]}/${parts[1]}/${parts[0]}`;
                                } else {
                                    hienThiNgay = query.tu_ngay;
                                }
                            }
                        %>
                        <input type="text" id="dateFrom" name="dateFrom" value="<%= hienThiNgay %>" class="form-control datepicker-input" placeholder="dd/mm/yyyy">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">Lọc</button>
                        <button type="button" onclick="danhSachLichHen()" class="btn btn-secondary">Xóa</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="mb-0">Tổng Số Lịch Hẹn: <strong><%= data.totalCount %></strong></p>
            <button onclick="themLichHen()" class="btn btn-success"><i class="fas fa-plus"></i> Thêm Lịch Hẹn</button>
        </div>

        <table class="table table-striped table-hover align-middle">
            <thead class="table-primary">
                <tr class="text-center">
                    <th>STT</th>
                    <th>Khung Giờ</th>
                    <th>Ngày Hẹn</th>
                    <th>Bệnh Nhân</th>
                    <th>SĐT</th>
                    <th>Trạng Thái</th>
                    <th>Loại</th>
                    <th>Ghi Chú</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody>
                <% if (data.appointments && data.appointments.length > 0) { 
                    data.appointments.forEach((item, index) => { %>
                    <tr class="text-center">
                        <td ><%= viTriOffset + index + 1 %></td>
                        <td ><%= item.gio %></td>
                        <td ><%= new Date(item.ngay).toLocaleDateString('vi-VN') %></td>
                        <td class="fw-bold"><%= item.ten_benh_nhan %></td>
                        <td><%= item.bn_sdt || '—' %></td>
                        <td>
                            <% 
                                const trangThaiClass = {
                                    'DA_DEN': 'bg-success', 'CHO_KHAM': 'bg-warning text-dark',
                                    'DA_HUY': 'bg-danger', 'CHUA_DEN': 'bg-secondary',
                                    'TAI_KHAM': 'bg-info text-dark', 'DA_HOAN_THANH': 'bg-primary',
                                    'DANG_KHAM': 'bg-primary'
                                };
                            %>
                            <span class="text-center badge <%= trangThaiClass[item.trang_thai] || 'bg-secondary' %>">
                                <%
                                    const statusMap = {
                                        'CHO_KHAM': 'Chờ khám', 
                                        'DA_DEN': 'Đã đến', 
                                        'DANG_KHAM': 'Đang khám',
                                        'DA_HOAN_THANH': 'Đã xong', 
                                        'DA_HUY': 'Đã hủy', 
                                        'TAI_KHAM': 'Tái khám',
                                        'CHUA_DEN': 'Chưa đến'
                                    };

                                    const displayStatus = statusMap[item.trang_thai] || item.trang_thai;
                                %>
                                <%= displayStatus %>
                            </span>
                        </td>
                        <td>
                            <% if (item.lh_loai === 'TAI_KHAM') { %>
                                <span class="badge rounded-pill bg-info text-dark">
                                    <i class="fas fa-history"></i> Tái khám
                                </span>
                            <% } else { %>
                                <span class="badge rounded-pill bg-success">
                                    <i class="fas fa-user-plus"></i> Mới
                                </span>
                            <% } %>
                        </td>
                        <td><%= item.ghi_chu || '—' %></td>
                        <td class="text-center">
                            <% if (item.lh_da_xoa) { %>
                                <span class="text-secondary small fst-italic">
                                    <i class="fas fa-trash-alt"></i> Đã xóa
                                </span>

                            <% } else { %>
                                <div class="btn-group">
                                    <button onclick="moModalSuaLichHen('<%= item.lh_ma %>')" class="btn btn-sm btn-info text-white" title="Sửa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    
                                    <button onclick="moModalXoaLichHen('<%= item.lh_ma %>')" class="btn btn-sm btn-danger" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>

                            <% } %>
                        </td>
                    </tr>
                <% }); } else { %>
                    <tr><td colspan="9" class="text-center">Không tìm thấy lịch hẹn nào.</td></tr>
                <% } %>
            </tbody>
        </table>

        <% if (data.totalPages > 1) { %>
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                
                <li class="page-item <%= data.currentPage === 1 ? 'disabled' : '' %>">
                    <button class="page-link" onclick="chuyenTrang('<%= data.currentPage - 1%>')" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </button>
                </li>

                <% for(let i = 1; i <= data.totalPages; i++) { %>
                    <li class="page-item <%= data.currentPage === i ? 'active' : '' %>">
                    <button class="page-link" onclick="chuyenTrang('<%= i %>')">
                                <%= i %>
                        </button>
                    </li>
                <% } %>

                <li class="page-item <%= data.currentPage === data.totalPages ? 'disabled' : '' %>">
                    <button class="page-link" onclick="chuyenTrang('<%= data.currentPage + 1 %>')" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </button>
                </li>
            </ul>
        </nav>
        <% } %>

        <%- include('partials/lichhen/modal_them') %>
        <%- include('partials/lichhen/modal_sua') %>
        <%- include('partials/lichhen/modal_xoa') %>

        <%- include('partials/modal_thanhcong') %>

    </main>
    <!-- <link rel="stylesheet" href="/css/partials/lichhen/modal_them.css"> -->
    <!-- <link rel="stylesheet" href="/css/partials/lichhen/modal_sua.css"> -->
    <!-- <link rel="stylesheet" href="/css/partials/lichhen/modal_xoa.css"> -->
    <link rel="stylesheet" href="/css/partials/modal_thanhcong.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/lichhen_danhsach.css">
    <script src="/js/lichhen_danhsach.js"></script>
</body>
</html>