<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title><%= title %></title>
    <%- include('partials/thuvien_js') %>
    <link rel="stylesheet" href="/css/benhnhan_danhsach.css">
    <link rel="stylesheet" href="/css/partials/placehoder_nghien.css">
  </head>

  <body>
    <%- include('partials/header') %>
    <main class="container my-4">
      <h1><%= title %></h1>

      <div id="filter-container" class="mb-4 p-3 bg-light border rounded">
        <form id="filterForm" onsubmit="event.preventDefault(); apDungBoLoc()">
          <label for="search" class="fw-bold">Tìm kiếm (Tên/SĐT):</label>
          <input
            type="text"
            id="search"
            name="search"
            value="<%= query.search || '' %>"
            class="form-control d-inline-block w-50 mx-2"
            placeholder="Nhập từ khóa..."
            autocomplete="off"
          />

          <button type="submit" class="btn btn-primary">Tìm kiếm</button>
          <button type="button" onclick="xoaBoLoc()" class="btn btn-secondary">
            Xóa lọc
          </button>
        </form>
      </div>

      <% if (typeof patients !== 'undefined' && Array.isArray(patients)) { %>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <p class="mb-0">
          Tổng số: <strong><%= patients.length %></strong> bệnh nhân
        </p>
        <button
          type="button"
          onclick="modalThemMoiBenhNhan()"
          class="btn btn-success"
        >
          <i class="fas fa-plus"></i> Thêm Bệnh nhân mới
        </button>
      </div>

      <% if (patients.length === 0) { %>
      <div class="alert alert-warning">Không tìm thấy bệnh nhân nào.</div>
      <% } else { %>
      <table class="table table-striped table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th class="text-center">Mã</th>
              <th class="text-center">Họ và Tên</th>
              <th class="text-center">Giới Tính</th>
              <th class="text-center">Ngày Sinh</th>
              <th class="text-center">SĐT</th>
              <th width="30%" >Địa Chỉ</th>
              <th class="text-center">Hành động</th>
            </tr>
          </thead>
          <tbody>
            <% patients.forEach(p => { %>
            <tr>
              <td class="text-center"><%= p.bn_ma %></td>
              <td class="fw-bold text-primary"><%= p.bn_ho_ten %></td>
              <td class="text-center">
                  <% if(p.bn_gioi_tinh === 'Nam') { %>
                      <span class="badge bg-info ">Nam</span>
                  <% } else if (p.bn_gioi_tinh === 'Nữ' || p.bn_gioi_tinh === 'Nu') { %>
                      <span class="badge bg-danger bg-opacity-75">Nữ</span>
                  <% } else { %>
                      -
                  <% } %>
              </td>
              <td>
                  <% if (p.bn_ngay_sinh) { %>
                      <%= new Date(p.bn_ngay_sinh).toLocaleDateString('vi-VN') %>
                  <% } else { %>
                      —
                  <% } %>
              </td>
              <td><%= p.bn_sdt || '—' %></td>
              <td><div class="scrollable-cell"><%= p.bn_dia_chi || '—' %></div></td>
              <td class="text-center">
                <div class="btn-group">
                    <button onclick="dangKyKhamNgay('<%= p.bn_ma %>', '<%= p.bn_ho_ten %>')" class="btn btn-sm btn-success" title="Đăng ký khám ngay">
                        <i class="fas fa-stethoscope"></i> Khám Ngay
                    </button>
                    <button onclick="chiTietBenhNhan('<%= p.bn_ma %>')" class="btn btn-sm btn-info text-white " title="Xem hồ sơ">
                         Chi tiết
                    </button>
                    
                    <button onclick="moModalSuaBenhNhan('<%= p.bn_ma %>')" class="btn btn-sm btn-warning text-white" title="Sửa thông tin">
                        Sửa
                    </button>

                    <button onclick="moModalXoaBenhNhan('<%= p.bn_ma %>', '<%= p.bn_ho_ten %>')" class="btn btn-sm btn-danger " title="Xóa">
                        Xóa
                    </button>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      <% } %> <% } else { %>
      <div class="alert alert-danger">Lỗi dữ liệu hệ thống.</div>
      <% } %>

      <%- include('partials/benhnhan/modal_them') %>
      <%- include('partials/benhnhan/modal_sua') %>
      <%- include('partials/benhnhan/modal_xoa') %>
      <%- include('partials/benhnhan/modal_xoaloi') %>
      <%- include('partials/modal_thanhcong') %>

    <script src="/js/benhnhan_danhsach.js"></script>
    <script src="/js/partials/benhnhan/modal_sua.js"></script>
  </body>
</html>
