<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | Hệ Thống QL Hồ Sơ Bệnh Án</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    </head>
<body>
    <%- include('partials/header') %>

    <main class="dashboard-container">
        
        <h2>Tổng Quan Hoạt Động Hôm Nay</h2>
        <section class="kpi-cards">
            <div class="card card-appointment">
                <i class="fas fa-calendar-check icon"></i>
                <p>Lịch Hẹn Hôm Nay</p>
                <span class="kpi-value" id="kpi-appointments"><%= data.kpi.appointments %></span>
            </div>
            <div class="card card-waiting">
                <i class="fas fa-hourglass-half icon"></i>
                <p>BN Đang Chờ Khám</p>
                <span class="kpi-value" id="kpi-waiting"><%= data.kpi.waiting %></span>
            </div>
            <div class="card card-revenue">
                <i class="fas fa-money-bill-wave icon"></i>
                <p>Tổng Thu Dự Kiến</p>
                <span class="kpi-value" id="kpi-revenue"><%= data.kpi.revenue ? data.kpi.revenue.toLocaleString('vi-VN') : '0' %> VNĐ</span>
            </div>
        </section>
        
        <hr>

        <section class="appointments-list">
            <h2>Lịch Hẹn Chi Tiết</h2>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Thời Gian</th>
                        <th>Họ Tên Bệnh Nhân</th>
                        <th>Trạng Thái</th>
                        <th>Ghi chú</th>
                        <th>Thao Tác</th>
                    </tr>
                </thead>
                <tbody id="appointments-body">
                    <% 
                    const statusMap = {
                        'CHO_KHAM': 'Chờ Khám',
                        'TAI_KHAM': 'Tái khám',
                        'DA_DEN': 'Đã đến',
                        'DANG_KHAM': 'Đang khám',
                        'DA_HOAN_THANH': 'Đã hoàn thành',
                        'DA_HUY': 'Đã hủy',
                        'CHUA_DEN': 'Chưa đến'
                    };

                    if (data.appointmentsList && data.appointmentsList.length > 0) { 
                        data.appointmentsList.forEach((item, index) => {
                            const statusKey = item.lh_trang_thai; 
                            const displayStatus = statusMap[statusKey] || statusKey;
                            const maLichHen = item.lh_ma;
                            const tenBenhNhan = item.bn_ho_ten; 
                            const timeDisplay = item.lh_khung_gio ? item.lh_khung_gio.substring(0, 5) : '—'; 
                    %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= timeDisplay %></td> 
                                <td><%= tenBenhNhan %></td> 
                                <td>
                                    <span class="status-badge status-<%= statusKey %>">
                                        <%= displayStatus %>
                                    </span>
                                </td>
                                <td>
                                    <span class="note-content">
                                        <%= item.lh_ghi_chu || '—' %>
                                    </span>
                                </td>
                                <td>
                                    <div id="action-buttons-<%= maLichHen %>" class="btn-group">
                                        <% 
                                            if (statusKey === 'CHO_KHAM' || statusKey === 'TAI_KHAM' || statusKey === 'CHUA_DEN') { 
                                        %>
                                            <button 
                                                class="btn-action btn-sm btn-success" 
                                                data-id="<%= maLichHen %>"
                                                data-name="<%= tenBenhNhan %>"
                                                onclick="receive(this)">
                                                Tiếp Đón
                                            </button>
                                            
                                        <% 
                                            } else if (statusKey === 'DA_DEN') { 
                                        %>
                                            <button 
                                                class="btn-action btn-sm btn-warning" 
                                                data-id="<%= maLichHen %>"
                                                data-name="<%= tenBenhNhan %>"
                                                onclick="examination(this)">
                                                Bắt Đầu Khám
                                            </button>
                                            
                                        <% 
                                            } else if (statusKey === 'DANG_KHAM') { 
                                        %>
                                            <button 
                                                class="btn-action btn-sm btn-primary" 
                                                data-id="<%= maLichHen %>"
                                                data-name="<%= tenBenhNhan %>"
                                                onclick="examination(this)">
                                                Tiếp tục Khám
                                            </button> 
                                        <% 
                                            } else { 
                                        %>
                                            <span class="text-muted font-italic">Không có hành động</span>
                                        <% } %>

                                        <% if (statusKey !== 'DA_HOAN_THANH' && statusKey !== 'DA_HUY') { %>
                                            <button 
                                                class="btn-action btn-sm btn-info ml-1" 
                                                data-id="<%= maLichHen %>"
                                                data-name="<%= tenBenhNhan %>"
                                                onclick="suaLichHen(this)">
                                                Sửa
                                            </button>
                                            <button 
                                                class="btn-action btn-sm btn-outline-danger ml-1" 
                                                data-id="<%= maLichHen %>"
                                                data-name="<%= tenBenhNhan %>"
                                                onclick="xoaLichHen(this)">
                                                Hủy
                                            </button>
                                        <% } %>
                                    </div>
                                </td>
                            </tr>
                    <% }); 
                    } else { 
                    %>
                        <tr>
                            <td colspan="6" style="text-align: center;">Hôm nay không có lịch hẹn nào.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </section>
        
        <hr>

        <section class="waiting-patients">
            <h2>Bệnh Nhân Đang Trong Quy Trình</h2>
            <ul id="waiting-list" class="simple-list">
                <% 
                    if (data.waitingPatients && data.waitingPatients.length > 0) { 
                        data.waitingPatients.forEach((patient) => { 
                %>
                    <li>
                        <i class="fas fa-procedures"></i> 
                        <%= patient.bn_ho_ten %> - <%= statusMap[patient.lh_trang_thai] || patient.lh_trang_thai %>
                        <a href="/khambenh/<%= patient.pkb_ma %>" 
                            style="margin-left: 10px; text-decoration: none;">[Xem chi tiết]</a>
                    </li>
                <% }); 
                    } else { 
                %>
                    <li>Không có bệnh nhân nào đang trong quy trình ngoài những người chờ khám.</li>
                <% } %>
            </ul>
        </section>

    </main>

    <footer>
        <p style="text-align: center; padding: 20px; color: #666;">&#169; 2025 Hệ Thống Quản Lý Hồ Sơ Bệnh Án</p>
    </footer>
    <script src="/js/partials/header.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
    <script src="/js/dashboard.js"></script>
</body>
</html>