<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | Hệ Thống QL Hồ Sơ Bệnh Án</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <%- include('partials/header') %>

    <main class="dashboard-container">
        
        <h2>Tổng Quan Hoạt Động Hôm Nay</h2>
        <section class="kpi-cards">
            <div class="card card-appointment">
                <i class="fas fa-calendar-check icon"></i>
                <p>Lịch Hẹn Hôm Nay</p>
                <span class="kpi-value" id="kpi-appointments"><%= data.kpi.appointments %></span>
            </div>
            <div class="card card-waiting">
                <i class="fas fa-hourglass-half icon"></i>
                <p>BN Đang Chờ Khám</p>
                <span class="kpi-value" id="kpi-waiting"><%= data.kpi.waiting %></span>
            </div>
            <div class="card card-revenue">
                <i class="fas fa-money-bill-wave icon"></i>
                <p>Tổng Thu Dự Kiến</p>
                <span class="kpi-value" id="kpi-revenue"><%= data.kpi.revenue %></span>
            </div>
        </section>
        
        <hr>

            <section class="appointments-list">
                <h2>Lịch Hẹn Chi Tiết</h2>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Thời Gian</th>
                        <th>Họ Tên Bệnh Nhân</th>
                        <th>Trạng Thái</th>
                        <th>Ghi chú</th>
                        <th>Thao Tác</th>
                    </tr>
                </thead>
                <tbody id="appointments-body">
                    <% 
                    if (data.appointmentsList && data.appointmentsList.length > 0) { 
                        data.appointmentsList.forEach((item, index) => {
                    %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= item.time %></td> 
                                <td><%= item.name %></td> 
                                <td>
                                    <%
                                        const statusKey = item.status.replace(/_/g,' ');
                                                                                
                                        let displayStatus = '';

                                        if (statusKey === 'DA DEN') {
                                            displayStatus = 'Đã đến';
                                        } else if (statusKey === 'CHO KHAM') {
                                            displayStatus = 'Chờ khám';
                                        } else if (statusKey === 'DA HUY') {
                                            displayStatus = 'Đã hủy';
                                        } else if (statusKey === 'CHUA DEN') { 
                                            displayStatus = 'Chưa đến';
                                        } else if (statusKey === 'TAI KHAM') {
                                            displayStatus = 'Tái khám';
                                        } else if (statusKey === 'DANG KHAM') {
                                            displayStatus ='đang khám';
                                        } else if (statusKey === 'DA HOAN THANH'){
                                            displayStatus = 'Đã hoàn thành';
                                        }   else {
                                            displayStatus = item.status;
                                        }
                                        %>
                                    <span class="status-badge status-<%= statusKey %>">
                                        <%= displayStatus %>
                                    </span>
                                    <span id="display-status-<%= item.lh_ma %>" style="display:none;"><%= item.status %></span> 
                                </td>
                                <td>
                                    <%
                                        const noteValue = item.note || ''; 
                                        const noteKey = noteValue.replace(/\s/g, '');
                                        const displayNote = noteValue.replace(/_/g, ' ');
                                    %>
                                    <span class="note-badge note-<%= noteKey %>">
                                        <%= displayNote %>
                                    </span>
                                </td>
                                <% 
                                    const maLichHen = item.lh_ma;
                                    const tenBenhNhan = item.name;
                                %>
                                <td>
                                    <div id="action-buttons-<%= maLichHen %>" class="btn-group">
                                        <% 
                                            if (statusKey === 'CHO KHAM' || statusKey === 'TAI KHAM' || statusKey === 'CHUA DEN') { 
                                        %>
                                            <button 
                                                class="btn-action btn-sm btn-success" 
                                                data-id="<%= maLichHen %>"
                                                data-name="<%= tenBenhNhan %>"
                                                onclick="receive(this)">
                                                Tiếp Đón
                                            </button>
                                            
                                        <% 
                                            } else if (statusKey === 'DA DEN') { 
                                        %>
                                            <button 
                                                class="btn-action btn-sm btn-warning" 
                                                data-id="<%= maLichHen %>"
                                                onclick="examination(this)">
                                                Bắt Đầu Khám
                                            </button>
                                            
                                        <% 
                                            } else if (statusKey === 'DANG KHAM') { 
                                        %>
                                            <button 
                                                class="btn-action btn-sm btn-primary" 
                                                data-id="<%= maLichHen %>"
                                                onclick="completeExamination(this)">
                                                Kết Thúc Khám
                                            </button>
                                            
                                        <% 
                                            } else { 
                                        %>
                                            <span class="text-muted font-italic">Không có hành động</span>
                                        <% } %>

                                        <% if (statusKey !== 'DA HOAN THANH' && statusKey !== 'DA HUY') { %>
                                            <button 
                                                class="btn-action btn-sm btn-info ml-1" 
                                                data-id="<%= maLichHen %>"
                                                onclick="suaLichHen(this)">
                                                Sửa
                                            </button>
                                            <button 
                                                class="btn-action btn-sm btn-outline-danger ml-1" 
                                                data-id="<%= maLichHen %>" 
                                                onclick="xoaLichHen(this)">
                                                Hủy
                                            </button>
                                        <% } %>
                                    </div>
                                </td>
                            </tr>
                    <% }); 
                    } else { 
                    %>
                        <tr>
                            <td colspan="5" style="text-align: center;">Hôm nay không có lịch hẹn nào.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </section>
         
        <section class="waiting-patients">
            <h2>Bệnh Nhân Đang Trong Quy Trình</h2>
            <ul id="waiting-list" class="simple-list">
                <% 
                    if (data.waitingPatients && data.waitingPatients.length > 0) { 
                        data.waitingPatients.forEach((patient) => { 
                %>
                    <li>
                        <i class="fas fa-procedures"></i> 
                        <%= patient.name %> - <%= patient.status %>
                        <a href="/khambenh/<%= patient.pkb_ma %>" 
                            style="margin-left: 10px; text-decoration: none;">[Xem chi tiết]</a>
                    </li>
                <% }); 
                    } else { 
                %>
                    <li>Không có bệnh nhân nào đang trong quy trình ngoài những người chờ khám.</li>
                <% } %>
            </ul>
        </section>

    </main>

    <footer>
        <p style="text-align: center; padding: 20px; color: #666;">&#169; 2025 Hệ Thống Quản Lý Hồ Sơ Bệnh Án</p>
    </footer>
    <script src="/js/partials/header.js"></script>
    <script src="/js/dashboard.js"></script>
</body>
</html>